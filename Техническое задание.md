# Техническое задание

## Назначение разработки
Изучение технологий построения системы распределенных вычислений

## Технические требования
Построить систему распределенных вычислений, состоящую из одного узла, выдающего задачу, и узла/узлов, решающих задачу. Формат задачи: математическая функция от одного аргумента и набор значений, от которых вычисляется заданная функция.

## Топология системы

Система состоит из:

1. Узел-задатчик (один)
1. Вычислительные узлы (один или множество)
1. При запуске вычислительные узлы рассылают multicast-пакеты по протоколу UDP
1. Вычислительные узлы соединяются каждый с каждым постоянно поддерживаемым сетевым соединением по протоколу TCP
1. Узел-задатчик подключается к заданному пользователем вычислительному узлу по протоколу TCP, отправляет задачу для вычисления, ждет результата без разрыва соединения, получает результат вычисления и отключается
1. Все узлы могут находиться на одном или нескольких устройствах
1. Все узлы находятся в пределах одной подсети

## Описание работы процедуры системы

Система распределенных вычислений выполняет параллельную обработку массива данных и представляет из себя одноранговую (peer-to-peer) сеть, состоящую из вычислительных узлов (вычислительный кластер). Также в системе присутствует узел-задатчик, который осуществляет выдачу заданий вычислительному кластеру и предоставляет интерфейс взаимодействия пользователю.

### Узел-задатчик

Получает задание от пользователя в виде рассчетной функции и массива данных, для каждого из которых необходимо рассчитать значение введенной функции. Связь узла-задатчика с вычислительным кластером осуществляется с помощью установления соединения по протоколу TCP с любым узлом кластера. Данные, полученные на вход узла-задатчика от пользователя сериализуются и направляются в вычислительный узел, к которому подключен задатчик. Возможно сжатие данных для ускорения процесса передачи.

### Вычислительный узел

Каждый узел вычислительного кластера имеет в своём составе следующие инструменты:
+ `Chunker service`
Выполняет взвешенное распределение рассчетной задачи между всеми вычислительными узлами кластера, опираясь на вычислительные мощности узлов-соседей (вычислительная мощность определяется исходя из пропускной способности канала соединения и собственной производительности узла). Также содержит в себе утилиту определения вычислительной мощности узла, с которым имеет соединение.
+ `Calculator service`
Выполняет десериализацию данных и последующие вычисления на основе полученной функции и массива чисел. Для парсинга и последующего рассчета входящей функции используется интерпретатор JS.
+ `Peer service`
Осуществляет взаимодействие с другими вычислительными узлами и содержит в себе информацию о всех действующих соединениях. Имеет в своём составе `Discovery Service`.

`Discovery service` выполняет периодическую проверку связности данного узла с другими узлами вычислительного кластера путём рассылки multicast-пакетов по протоколу UDP. При обнаружении новых узлов (вновь добавленных или тех, с кем не удалось ранее осуществить соединение), посылает сигнал `Peer service`, который выполняет необходимые действия по установлению соединения.

## Интерфейс системы

### Программа **compnode**

Запускает вычислительный узел. Консольный интерфейс.

Формат вызова: `compnode -u <udp_port> [-t <tcp_port>] [args...]`

Аргументы:
- `-u <udp_port>` - порт для multicast рассылок по протоколу UDP
- `-t <tcp_port>` - порт для входящих подключений по TCP. Если не задано, задается автоматически
- `--help, -h` - вызов справки
- `--quiet, -q` - тихий режим, без вывода информации
- `--verbose, -v` - подробный режим, с выводом дополнительной информации
- `--debug, -d` - режим с выводом отладочной информации

### Программа **tasknode**

Запускает узел-задатчик. Консольный интерфейс.

Формат вызова: `tasknode <compnode_ip>:<compnode_port> -i {<input_file>|-} -o {<output_file>|-} [args...]`

Аргументы:
- `<compnode_ip>:<compnode_port>` - ip-адрес и порт вычислительного узла, к которому будет выполняться подключение
- `-i <input_file>` - чтение задачи из файла `<input_file>`
- `-i -` - чтение задачи из стандартного ввода
- `-o <output_file>` - запись результата в файл `<output_file>`
- `-o -` - запись результата в стандартный вывод
- `--help, -h` - вызов справки
- `--quiet, -q` - тихий режим, без вывода информации
- `--verbose, -v` - подробный режим, с выводом дополнительной информации
- `--debug, -d` - режим с выводом отладочной информации

## Входные данные

На вход узла-задатчика подаётся файл, содержащий в первой строке задачу-функцию в формате выражения, и далее по одному значению аргумента функции в новой строке.

Математические оператары записываются следующим образом:
1. '+' - сложение;
2. '-' - вычитание;
3. '*' - умножение;
4. '**' - возведение в степень;
5. '/' - деление;
6. 'sin()' - тригонометрический синус;
7. 'cos()' - тригонометрический косинус;
8. 'tg()' - тригонометрический тангенс;
9. 'ctg()' - тригонометрический котангенс;
10. '( некоторое выражение )' - возможно использование скобок;
Примечание: аргументы тригонометрических функций воспринимаются в радианах.

Пример содержимого входного файла:
```
x**4+sin(x)
12433
68659
4
608381
-438948
```

## Выходные данные

На выход, на узел-задатчик система возвращает файл, где содержатся, аналогично входу, построчно пересчитанные функцией значения аргумента, каждый в новой строке, соотвественно.

## Базовые сценарии тестирования

1. Запуск одного узла (не должен упасть).
2. Запуск двух узлов на одном компьютере (должны соединиться друг с другом).
3. Запуск двух узлов на разных компьютерах (должны соединиться друг с другом).
4. Проверка на загрузку файла (задатчик готов принять файл).
6. Загрузка файла в задатчик (задатчик принимает данные и проверяет их на корректность).
7. Выдача задачи производится только на один узел (узел ждёт получения данных).
8. Выдача задачи на кластер из одного узла (должен правильно посчитать).
9. Выдача задачи на кластер из нескольких узлов (должны поделить задачу).
10. Вычисление задачи на кластере(должен обработать данные).
11. Возвращение результата на прошлый узел (уведомляет об отправки результата на прошлый узел).
12. Возвращение конечного результата на задатчик (система должна показывать выполненный результат).

## Ручное тестирование

Тест-кейс 1. Запуск одного узла. <br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку compnode -u <udp_port><br/>
Ожидаемый результат: не должно быть сообщении об ошибки.

Тест-кейс 2. Запуск двух узлов на одном компьютере. <br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку 2 раза compnode -u <udp_port> [-v]<br/>
Ожидаемый результат: должны соединиться друг с другом


Тест-кейс 3. Запуск двух узлов на разных компьютерах. <br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку tasknode <compnode_ip>:<compnode_port> -i {<input_file>|-} -o {<output_file>|-} [-v]<br/>
Ожидаемый результат: должны соединиться друг с другом.


Тест-кейс 4. Проверка на загрузку файла. <br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку compnode compnode -u <udp_port> [-v]<br/>
Ожидаемый результат:задатчик готов принять файл.


Тест-кейс 5. Загрузка файла в задатчик. <br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку параметр tasknode <compnode_ip>:<compnode_port> -i {<input_file>|-} [-v]<br/>
Ожидаемый результат: задатчик принимает данные без ошибое


Тест-кейс 6. Выдача задачи производится только на один узел. <br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку tasknode <compnode_ip>:<compnode_port> -i {<input_file>|-} -o {<output_file>|-} [-v]<br/>
Ожидаемый результат: узел ждёт получения данных


Тест-кейс 7.Выдача задачи на кластер из одного узла.<br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку параметр tasknode <compnode_ip>:<compnode_port> -i {<input_file>|-} [-v]<br/>
Ожидаемый результат: должен правильно посчитать

Тест-кейс 8. Выдача задачи на кластер из нескольких узлов. <br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку параметр tasknode <compnode_ip>:<compnode_port> -i {<input_file>|-} [-v]<br/>
Ожидаемый результат: должен распределить нагрузку задачи на несколько узлов


Тест-кейс 9. Вычисление задачи на кластере. <br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку compnode -u <udp_port> [-v]<br/>
Ожидаемый результат: получение и решение задачи на конечных узлах без ошибок


Тест-кейс 10. Возвращение результата на прошлый узел.<br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку параметр tasknode <compnode_ip>:<compnode_port> -i {<input_file>|-} [-o]<br/>
Ожидаемый результат: возвращает по частям решение задачи без ошибок


Тест-кейс 11. Возвращение конечного результата на задатчик.<br/>
Шаги:<br/>
1)Запустить комадную строку<br/>
2)Ввести в командную строку параметр tasknode <compnode_ip>:<compnode_port> -i {<input_file>|-} [-o]<br/>
Ожидаемый результат: система должна показывать выполненный результат